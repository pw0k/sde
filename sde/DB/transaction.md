### Уровни изоляции транзакций в PostgreSQL

1. **Read Uncommitted (Чтение неподтвержденных данных)**
    - **Особенности**:
        - PostgreSQL интерпретирует этот уровень как Read Committed.
        - **Грязные чтения** не допускаются.
2. **Read Committed (Чтение подтвержденных данных)**
    - **По умолчанию в PostgreSQL**.
    - **Особенности**:
        - Каждая команда внутри транзакции видит только те данные, которые были подтверждены до начала выполнения этой команды.
        - Возможны **неповторяющиеся чтения** и **фантомные записи**.
3. **Repeatable Read (Повторяемое чтение)**
    - **Особенности**:
        - Транзакция видит снимок базы данных на момент ее начала.
        - Предотвращает **неповторяющиеся чтения**.
        - Возможны **фантомные чтения**.
4. **Serializable (Сериализуемый)**
    - **Самый строгий уровень изоляции**.
    - **Особенности**:
        - Транзакции выполняются так, будто они происходят последовательно.
        - Предотвращает **фантомные чтения**.
        - Может привести к ошибкам сериализации, требующим повторного выполнения транзакции.

### Типы аномалий и их предотвращение

- **Dirty Read (Грязное чтение)**: Чтение данных, измененных, но не подтвержденных другой транзакцией. **Предотвращается**: на всех уровнях изоляции в PostgreSQL.
- **Non-Repeatable Read (Неповторяющееся чтение)**: Повторное чтение тех же данных дает разные результаты. **Предотвращается**: на уровнях Repeatable Read и Serializable. Например при построении отчетов
- **Phantom Read (Фантомное чтение)**: Изменение набора строк, соответствующих условию запроса. **Предотвращается**: на уровне Serializable.

### Практические рекомендации

- **Read Committed**: Используйте для общего баланса между производительностью и изоляцией.
- **Repeatable Read**: Подходит, когда важно получать повторяемые результаты в пределах одной транзакции.
- **Serializable**: Используйте, когда необходима максимальная изоляция, но будьте готовы обрабатывать ошибки сериализации.
### **Пессимистические и оптимистические блокировки**
#### **Пессимистическая блокировка**
**Описание:**
- Предполагает, что конфликты вероятны.
- При чтении или изменении данных транзакция **блокирует** ресурсы, предотвращая их изменение другими транзакциями до завершения операции.

**Реализация в PostgreSQL:**
- Используется оператор `SELECT ... FOR UPDATE / SKIP LOCKED`.
#### **Оптимистическая блокировка**
**Описание:**
- Исходит из предположения, что конфликты редки.
- Транзакции не блокируют данные при чтении.
- При попытке записи проверяется, не были ли данные изменены другими транзакциями.

**Реализация:**
- Добавление поля версии или отметки времени (`version` или `timestamp`) в таблицу.
- При обновлении данных сравнивается текущая версия с той, что была при чтении.
```
UPDATE rooms 
SET status = 'booked', version = version + 1 
WHERE room_id = 102 AND version = 1;
```